<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.store.goguma.repository.ProductRepository">

	<!-- 중고상품 전체 -->
	<select id="findAllProduct">
		select * from product where delete_yn = 'N' and
		confirm_yn = 'N'
	</select>

	<!-- 중고상품 조회 -->
	<select id="findAllBypId">
		SELECT p.*, COALESCE(w.countWishList, 0) AS countWishList,
		COALESCE(cr.countChatRoom, 0) AS countChatRoom
		FROM product p
		LEFT JOIN (
		SELECT p_id, COUNT(p_id) AS countWishList
		FROM wish_list
		GROUP BY p_id
		) AS w ON p.p_id = w.p_id
		LEFT JOIN (
		SELECT p_id, COUNT(p_id) AS countChatRoom
		FROM chat_room
		GROUP BY p_id
		) AS cr ON p.p_id = cr.p_id
		WHERE p.p_id = #{pId}
	</select>

	<!-- host_id로 상품 조회 -->
	<select id="findByHostId">
		select * from product
		where host_id = #{hostId}
		and
		delete_yn = 'N'
		and confirm_yn = 'N'
	</select>

	<select id="findWishAndChat">
		SELECT p.*, COALESCE(w.countWishList, 0) AS
		countWishList,
		COALESCE(cr.countChatRoom, 0) AS countChatRoom
		FROM (
		SELECT p_id, COUNT(p_id) AS countWishList
		FROM wish_list
		GROUP BY p_id
		ORDER BY countWishList DESC
		LIMIT 6
		) AS w
		JOIN product p ON w.p_id =
		p.p_id
		LEFT JOIN (
		SELECT p_id, COUNT(p_id) AS countChatRoom
		FROM
		chat_room
		GROUP BY p_id
		) AS cr ON p.p_id = cr.p_id
	</select>

</mapper>