<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.store.goguma.repository.UserRepository">

	<select id="selectByEmail"
		resultType="com.store.goguma.entity.User">
		select * from user where CONCAT(social, email) =
		#{userEmail}
	</select>

	<update id="updateUser">
		update `user` set
		<if test="#{zip} == null || #{tel} == null">
			`zip`=#{zip},
			`address`=#{address},
		</if>
		`tel`=#{tel},
		`file`=#{file},
		`update_at`=NOW()
		where `social`=#{social}
		and `email`=#{email}
	</update>


	<select id="findAllByuId"
		resultType="com.store.goguma.entity.User">
		select * from user where u_id = #{uId} AND delete_yn = 'N'
	</select>

	<select id="countUserAll" resultType="int">
		select count(*) from user
	</select>

	<select id="findAll" resultType="com.store.goguma.entity.User">
		select * from user
		where name
		like CONCAT('%',#{name},'%')
		limit #{start} , 10
	</select>

	<select id="countFindAll" resultType="int">
		select count(*) from user
		where name like CONCAT('%',#{name},'%')
	</select>

	<update id="adminUpdateUserRole">
		update user
		set role = #{role} , update_at = now()
		where u_id = #{uId};
	</update>

	<select id="findProfileById" resultType="com.store.goguma.user.dto.UserProfileDto">
		select u.* , ifnull(count(p.p_id), 0) as countProduct
		,ifnull(count(q.id), 0) as countQna, ifnull(count(w.u_id), 0) countWishList from user u
		left join product p
		on p.host_id = u.u_id
		left join qna q
		on q.u_id = u.u_id
		left join wish_list w
		on w.u_id = u.u_id
		where
		u.u_id = #{userId}
		group by u.u_id
	</select>
	
	<update id="deleteUser">
		update user 
		set delete_yn = 'Y' , delete_at = now()
		where u_id = #{userId}
	</update>
</mapper>